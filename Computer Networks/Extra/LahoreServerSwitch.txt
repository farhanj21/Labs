# Create Simulation
set ns [new Simulator]

# Trace Files for NAM
set nf [open out.nam w]
$ns namtrace-all $nf

# Finish Procedure
proc finish {} {
    global ns nf
    $ns flush-trace
    close $nf
    exec nam out.nam &
    exit 0
}

# Routing Algorithm (Distance Vector)
$ns rtproto DV

# Node creation
set pci [$ns node]
set pc2 [$ns node]
set pc3 [$ns node]
set pc4 [$ns node]
set switch_garden [$ns node]
set switch_johar [$ns node]
set switch_faisal [$ns node]
set switch_gulberg [$ns node]
set lahore_server [$ns node]
set server [$ns node]

# Links Creation
$ns duplex-link $switch_garden $lahore_server 512Kb 10ms SFQ
$ns duplex-link $switch_johar $lahore_server 512Kb 10ms SFQ
$ns duplex-link $switch_faisal $lahore_server 512Kb 10ms SFQ
$ns duplex-link $switch_gulberg $lahore_server 512Kb 10ms SFQ

# Transport Layer
set tcp_agent1 [new Agent/TCP]
$ns attach-agent $pci $tcp_agent1
set ftp1 [new Application/FTP]
$ftp1 attach-agent $tcp_agent1

set tcp_agent2 [new Agent/TCP]
$ns attach-agent $pc2 $tcp_agent2
set ftp2 [new Application/FTP]
$ftp2 attach-agent $tcp_agent2

set udp_agent1 [new Agent/UDP]
$ns attach-agent $pc3 $udp_agent1
set cbr1 [new Application/Traffic/CBR]
$cbr1 attach-agent $udp_agent1

set udp_agent2 [new Agent/UDP]
$ns attach-agent $pc4 $udp_agent2
set cbr2 [new Application/Traffic/CBR]
$cbr2 attach-agent $udp_agent2

# CBR Parameters
$cbr1 set packetSize_ 1024
$cbr1 set rate_ 256Kbps
$cbr2 set packetSize_ 1024
$cbr2 set rate_ 256Kbps

# Event Scheduling
$ns at 0.2 "$ftp1 start"
$ns at 2.8 "$ftp1 stop"
$ns at 0.2 "$ftp2 start"
$ns at 2.8 "$ftp2 stop"
$ns at 0.5 "$cbr1 start"
$ns at 2.6 "$cbr1 stop"
$ns at 0.5 "$cbr2 start"
$ns at 2.6 "$cbr2 stop"

# Link Up/Down
$ns rtmodel-at 1 down $switch_garden $lahore_server
$ns rtmodel-at 25 up $switch_garden $lahore_server
$ns rtmodel-at 1.3 down $switch_johar $lahore_server
$ns rtmodel-at 2.35 up $switch_johar $lahore_server
$ns rtmodel-at 1.5 down $switch_faisal $lahore_server
$ns rtmodel-at 2.4 up $switch_faisal $lahore_server
$ns rtmodel-at 1.7 down $switch_gulberg $lahore_server
$ns rtmodel-at 2.6 up $switch_gulberg $lahore_server

# Ending Simulation
$ns at 3.0 "finish"

# Run Simulation
$ns run
